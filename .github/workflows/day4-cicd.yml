#Create Pipeline with name
name: Rajkumar App containerization Pipeline
#Trigger section -- When this pipelin should start 
on:
  push:
    branches:
    - "dev"

#jobs - what jobs need to perform

jobs:
  rajkumar-image-build:
    runs-on: ubuntu-latest
    #This server will be provison by github backend for this job
    steps:
    - name: run some basic commands on above server to do some verification
      run: "uname -r \nwhoami\ncat /etc/os-release\ndocker version\ndocker-compose version\n"
    - name: using pre-defined github workflow to get copy github repo code to runners
      uses: actions/checkout@v4

    - name: Offical Sonarqube scan update
      uses: SonarSource/sonarqube-scan-action@v2.1.0
      with:
        projectBaseDir: ./python-app-secret
        args: >
          -Dsonar.projectKey=rajk-project 
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

    - name: Docker python app build
      run: |
        ls -a
        cd python-app-secret
        docker-compose up -d
        sleep 2
        docker-compose ps
        sleep 1
        docker-compose logs


    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@0.20.0
      with:
          image-ref: 'rajkpython:v1'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'